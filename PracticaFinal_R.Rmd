---
title: "Pràctica Final"
author: "Cristian Subirana"
header-includes:
  - \usepackage{float}
  - \makeindex
date: "25 de Decembre de 2019"
output:
  pdf_document: 
    toc: true
    toc_depth: 4  
    number_sections: true  
    highlight: tango  # specifies the syntax highlighting style
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,fig.pos = 'H')
```
## Descripció del dataset
El dataset seleccionat per a realitzar aquesta pràctica ha estat el referent al enfonsament del titànic.

El motiu de elecció d'aquest dataset és purament didàctic, juntament amb la possibilitat de participar en el concurs organitzat per Kaggle, on es presenta el repte de crear el millor algoritme de Machine learning capaç de donar els millors resultats alhora de saber qui sobreviu al accident. 

L'objectiu d'aquest projecte es aplicar els coneixements assolits durant l'assignatura, juntament amb aconseguir un model capaç de predir per a cada passatger si sobreviu.

### Presentació de les dades

En el data set proporcionat per kaggle, podem trobar dos subconjunts de dades, el fitxer train.csv i el fitxer test.csv.

El primer fitxer serà utilitzar per estudiar les dades, tractar-les i formular un model capaç de predir si un passatger sobreviu o no. Un cop finalitzar s'entrenarà el model utilitzant el fitxer train.csv.

El conjunt de variables disponibles en el fitxer traint.csv:

-	PassengerId: Identificador numèric únic per identificar el passatger.
-	Survived: Flag referent a si el passatger ha sobreviscut o no.
-	Pclass: Classe en la que viatjava el passatger.
-	Name: Nom del passatger.
-	Sex: Sexe del passatger.
-	Age: Edat del passatger.
-	SibSp: Nombre de germans o acompanyants del passatger.
-	Parch: Nombre de pares/fills del passatger.
-	Ticket: Número de ticket del passatger.
-	Fare: Tarifa del passatger.
-	Cabin: Cabina seleccionada pel passatger.
-	Embarked: Port on ha embarcat el passatger.

Els camps comentats es veuran afectats al llarg de la pràctica a fi de poder ser analitzats. Inicialment no es descartarà cap variable, ja que tot i que algunes de elles poden no semblar útils en el anàlisi, com per exemple el nom de passatger, poden resultar útils, pel que es mantindran el màxim de variables disponibles.


## Integració i selecció de les dades

Primer de tot, necessitem carregar el dataset. On combinarem les dades de train i test juntes, ja que analitzar-les per separat no te sentit ja que realment són fragments de la mateix font. Les dades de test tenen la mateix estructura que les de train però aquestes no contenen la variable Survived, el qual creem per poder fusionar les dos fonts. Inicialment evaluare'm la columna creada a test amb NA's

```{r message=FALSE, warning=FALSE, paged.print=FALSE}
library(readr)
train_x <- read_csv("C:/Users/PcCom/Desktop/titanic/train.csv")
test_x <- read_csv("C:/Users/PcCom/Desktop/titanic/test.csv")

test_x$Survived<-NA
```

Combinem test i train
```{r}
train<-rbind(train_x,test_x)
```

Observe'm el resultat:
```{r}
str(train)
```

Un cop ja el tenim carregat, observare'm les dades visualment tal i com són sense aplicar cap procés previ, a fi de tenir una idea general de com són.
Per a fer-ho farem les següents consultes:

```{r}
summary(train)
head(train)
```
Observem que al veure el resum del dataset podem treure algunes conclusions que ens ajudaran a entendre les dades.


La variable candidata a ser exclosa del analisi és el camp Ticket, ja que és un identificador del ticket, dels quals no considero rellevant alhora de decidir qui sobreviu.

Veiem que la mitjana d'edat de les persones que van sobreviure al desastre és del 38%, on majoritariament eren persones que viatjaven amb classe mitja, amb una mitjana d'edat d'uns 30 anys, dels quals majoritariament viatjaven sols.

Cal considerar que a la variable Age,Fare són les única variables que contenen NA's pel que en el següents apartats s'hauran de tractar.

Al observar el resultat de fer un head() de les dades veiem que hi ha un conjunt de  camps que requeriran d'un treball extra tant de anàlisis com de transformació. 


Variables com Cabin, veiem que estan definides com una lletra i un nombre referent a la cabina, on la lletra fa referència a quina altura estava la cabina.

Observe'm la següent imatge per a tindre'n una idea de com estaven distribuïdes aquestes cabines per tal de saber la importància de la lletra que conté.

```{r Titanic, echo=FALSE, fig.align="center", fig.cap="Titanic", out.width="50%"}
knitr::include_graphics("/Users/PcCom/Desktop/UOC/Tipologia i cicle de dades/titanic.png")
```


Observe'm en la imatge, que a major lletra, més aprop del bots salvavides es troben i millor accés a la superfície, per tant, pot ser un factor a tenir en compte alhora de saber si sobreviu o no.


El camp referent a Embarked, fa referència als ports des de els quals els passatgers van embarcar, sent C=Cherbourg, Q=Queenstown i S=Southampton.

En la següent imatge podem veure les embarcacions presents per pujar al titanic

```{r Embarcacions, echo=FALSE, fig.align="center", fig.cap="Embarcacions", out.width="50%"}
knitr::include_graphics("/Users/PcCom/Desktop/UOC/Tipologia i cicle de dades/titanic-embarcation.jpg")
```


## Neteja de les dades

En aquest apartat tractarem les variables del dataset, per tal de gestionar els nulls, NA's i valors buits. Acte seguit es preparan les variables per a poder ser analitzades correctament.

En el últim head() utilitzat podem apreciar que la variable Cabin, tot i que al fer summary() de dataset no ens ha sortit que contingui NA's, apreciem clarament que en conté.

El primer pas que farem és eliminar la variable Ticket del anàlisi tal i com s'ha explicat anteriorment

```{r}
train_c1<-train[,-which(names(train)=="Ticket")]
```

Comprove'm que ja no hi és:
```{r}
summary(train_c1)
```

### Variables PassengerId i Survived

Aquestes dos variables no seran transformades degut a que PassengerId ens permetrà en tot moment identificar el passatger i Survived és la variable sobre la que volem realitzar l'anàlisi. Hem de tenir en compte que per poder pujar el resultat del projecte a Kaggle es requereixen de només dues columnes, PassengerId i Survived.


### Variable Name

Aquesta variable contenia el nom del passatger. Observe'm els seus valors.

```{r warning=FALSE}
head(train_c1$Name)
```
Veiem que aquest camp, pot semblar poc important, ja que el passatger es digui Pep o Marc difícilment influenciarà si el supervivent sobreviu.

Aquest camp també conté el títol amb el que ens dirigiríem al passatger, el qual podem entendre que pot ser el estatus o nivell social del passatger, el qual sí que pot influenciar en sí sobreviu.

Per tant, hem de netejar aquest camp, deixant només el que vindria a ser el titol.

Separe'm els noms per caracters com comes o punts i seleccionem únicament el títol
```{r warning=FALSE}
library(stringr)
train_c1$Title<-sapply(train_c1$Name,FUN = function(x) str_trim(unlist(strsplit(x,split='[,|.]'))[2]))
```


Observe'm el resultat de netejar la variable Name:
```{r warning=FALSE}
table(train_c1$Title)
```

Veiem que podríem dividir els titols segons si el passatger es una dona, noia, home o noi per exemple. 

Primerament hem de tenir en compte el següent:

Mr->Home adult, independentment del seu estat civil
Mrs->Dona casada
Miss->Dona soltera jove
Ms->Dona adulta, independement del seu estat civil
Sir->Home de classe alta o distinguit per la seva profesió o conducta, respecte o cortesia
Mme->Dona de classe alta o distinguida per la seva profesió o conducta, respecte o cortesia, equivaldria a Madam
Sir the Countess->Home amb carrec molt important, compte
Lady->Forma aducada de dirigirse a una dona
Capt->Capità, mariner com a professió
Major->carrec molt important dins d'una area 
Master-> Per referirse a nens
Rev->Sacerdot
Dr-> Doctor en medicina
Mlle->Equivalent de mademoiselle o de Miss
Jonkheer->titol nobiliari especific de la familia comentada
Col<-coronel
The countess<- compte

Observe'm que hi han equivalències en les definicions el qual poden ser degudes a que la majoria de tripulants provenien de França, Regne Unit i els Estats Units principalment, i per referir-nos al mateix, degut a l'idioma s'escriuen diferent.

Per a verificar els titols, s'han comprovat dels passatgers, quina funció tenien dins del titanic a https://www.encyclopedia-titanica.org/

Gràcies a aquesta verificació s'ha comprovat que el dataset no inclou els treballadors del vaixell,en que el passatger amb títol capità, no era el capità del vaixell, sinó que era capità d'un altre vaixell, i estava de viatje turístic al titanic.

Un cop comentat el següent es faran les següents agrupacions:

Nens<-Master
Dona soltera<- Miss,Mlle
Dona casada<-Mrs
Dona sense estat civil<-Ms,Lady
Home sense estat civil<-Mr,Sir
Home de classe alta<-Sir the Countess,Capt,Major,Jonkheer,Don,Col
Dona de classe alta<-Mme
Sacerdot<-Rev
Doctors<-Dr

Prepare'm variables
```{r warning=FALSE}
nens<-c("Master")
dona_soltera<-c("Miss","Mlle")
dona_casada<-c("Mrs")
dona_sense_estat_civil<-c("Ms","Lady")
home_sense_estat_civil<-c("Mr","Sir")
home_clase_alta<-c("the Countess","Capt","Major","Jonkheer","Don","Dona","Col")
dona_clase_alta<-c("Mme")
sacerdot<-c("Rev")
doctor<-c("Dr")
```

Creem una nova variable al dataset
```{r warning=FALSE}
train_c1$Title_refactor<-vector(mode="character",length = nrow(train_c1))
```

Afegim les dades al nou camp segons el tipus de títol especificat anteriorment
```{r warning=FALSE}
train_c1$Title_refactor[train_c1$Title %in% nens]<-"Nens"
train_c1$Title_refactor[train_c1$Title %in% dona_soltera]<-"Dona soltera"
train_c1$Title_refactor[train_c1$Title %in% dona_casada]<-"Dona casada"
train_c1$Title_refactor[train_c1$Title %in% dona_sense_estat_civil]<-"Dona sense estat civil"
train_c1$Title_refactor[train_c1$Title %in% home_sense_estat_civil]<-"Home sense estat civil"
train_c1$Title_refactor[train_c1$Title %in% home_clase_alta]<-"Home clase alta"
train_c1$Title_refactor[train_c1$Title %in% dona_clase_alta]<-"Dona clase alta"
train_c1$Title_refactor[train_c1$Title %in% sacerdot]<-"Sacerdot"
train_c1$Title_refactor[train_c1$Title %in% doctor]<-"Doctor"
```

Test de la nova variable
```{r warning=FALSE}
head(train_c1)
```

Test de la nova variable
```{r warning=FALSE}
unique(train_c1$Title_refactor)
```


### Variable Age
A continuació la variable a estudiar és "Age", el qual havíem vist que conté NA's.

Per a trobar una solució, tenim varis camins pels quals optar:

1. Substituir els NA's per les mitjanes de edat.
2. Substituir els NA's per la mitjana de edat per cada títol.
3. Aplicar kNN per a substituir els NA's

Crec que la opció 3 seria la més idonea, ja que en la opció 1, pot apareixer un important esbiaix. La opció 2 també seria viable, però la opció de utilitzar knn és la més recomanada especialment per a variables numériques.

Primerament per a que el knn sigui òptim, normalitzem la variable Age
```{r warning=FALSE}
train_c1$Age<-scale(train_c1$Age)
```

Apliquem knn per a substituir els NA's
```{r warning=FALSE}
library(VIM)
x<-kNN(train_c1,variable = c("Age"),k=5)
train_c1<-x

```
Revise'm resultat
```{r warning=FALSE}
summary(train_c1)

```


Finalment veiem que ja no hi han NA's.


### Variable Embarked

En la variable Embarked observe'm que hi han NA's pel que hem de decidir com tractar-los.
```{r}
unique(train_c1$Embarked)
```
Al ser variables categòriques, ens podem basar en la categoria més abundant, el qual substituirà els NA's.

Busquem quina categoria és la més habitual.

```{r}
xtabs(~Embarked,data=train_c1)
```

Veiem que el embarcament majoritari és S.
```{r}
train_c1$Embarked[is.na(train_c1$Embarked)]<-'S'
```

Revise'm que ja no apareixin més NA's al camp.
```{r}
unique(train_c1$Embarked)
```


### Variable Cabin

La variable Cabin en el dataset de training conté 1014 NA's
```{r}
length(which(is.na(train_c1$Cabin)))

```
Hem de tenir en compte que en aquesta variable, no tothom tenia cabina associada, pel que el volum de cabines ocupades no coincidirà amb el nombre de passatgers, a més que hi havia passatgers que compartien cabina.

El que ens interessaria d'aquesta variable és la primera lletra que conté la variable, ja que aquesta referencía al pis/bloc dins del vaixell, on anteriorment hem mostrat una imatge amb la distribució de les cabines.
L'ordre de les cabines anava des de les lletres A fins a Z
```{r}
unique(substr(train_c1$Cabin,1,1))
```


Observe'm que hi ha un valor que desconeixem, el valor "T". Si ens fixem en la dsitribució de les cabines per la lletra de la imatge anterior, veiem que no hi apareix cap T, tot i que realment existia.
Podem trobar-la a https://www.encyclopedia-titanica.org/titanic-deckplans/boat-deck.html

Si observe'm el vaixell des de una vista superior, veiem que hi ha una cabina adalt de tot, el qual és única que fa referència aquest "T", pel que podríem considerar que la situació de la cabina T és més propera als bots salvavides que les cabines "A".

Un cop finalitzat aquest estudi, modificarem el camp cabina, deixant només la lletra de la cabina a la que fa referència. En el cas dels NA's se'ls assignarà la lletra Z, com els menys accesibles als bots.


```{r}
train_c1$Cabin[is.na(train_c1$Cabin)]<-'Z'
train_c1$Cabin<-substr(train_c1$Cabin,1,1)
```

Comprove'm el resultat
```{r}
unique(substr(train_c1$Cabin,1,1))
```

### Variable Pclass

Creem una nova variable al dataset
```{r}
train_c1$classe<-vector(mode="character",length = nrow(train_c1))
```

Afegim les dades al nou camp segons el tipus de titol especificat anteriorment
```{r}
train_c1$classe[train_c1$Pclass==1]<-"Alta"
train_c1$classe[train_c1$Pclass==2]<-"Mitja"
train_c1$classe[train_c1$Pclass==3]<-"Baixa"

```

```{r}
unique(train_c1$classe)
```



### Variable SibSp i Parch

Aquestes variables les deixem tal i com estan.


### Variable Fare

Degut a que aquesta variable conté NA's hem de realitzar un procés semblant al realitzat per la variable Age.
```{r warning=FALSE}
train_c1$Fare<-scale(train_c1$Fare)
```

Apliquem knn per a substituir els NA's
```{r warning=FALSE}
library(VIM)
x<-kNN(train_c1,variable = c("Fare"),k=5)
train_c1<-x

```
Revise'm resultat
```{r warning=FALSE}
summary(train_c1)

```


Cal tenir en compte que hi han valors de ticket=0, el qual pot semblar un outlier, però el motiu d'aquest valor, és degut a que en el titanic, per un mateix ticket podien entrar N passatgers, pel que el valor del ticket va associat al passatger que el va pagar, però els seus acompanyants apareix amb valor 0. Un acompanyant pot no ser familiar ni parella, pot ser per exemple amics o "nanny's".



Netejem les variables que no necessitem finalment
```{r}
train_c1<-train_c1[,-which(names(train_c1)=="Title")]
```

```{r}
train_c1<-train_c1[,-which(names(train_c1)=="Fare_imp")]
```

```{r}
train_c1<-train_c1[,-which(names(train_c1)=="Age_imp")]
```



```{r}
head(train_c1)
```

### Dataset Final

Prepare'm el nou dataset:
```{r}
train_net<-train_c1[,-which(names(train_c1) %in% c("Pclass","Name"))]

```

```{r}
summary(train_net)
```

```{r}
#str(train_net)
train_net$Sex<-as.factor(train_net$Sex)
train_net$Cabin<-as.factor(train_net$Cabin)
train_net$Embarked<-as.factor(train_net$Embarked)
train_net$Title_refactor<-as.factor(train_net$Title_refactor)

train_net$classe<-as.factor(train_net$classe)


train_net$Survived<-as.factor(train_net$Survived)

```



##  Anàlisi de les dades

### Test de normalitat
Degut a que el dataset ha estat preparat o orientat a fer ús de regressió, on la majoria de variables no són numériques, utilitzarem el dataset antic, on no hi han NA's, és a dir, que s'ha fet un tractament de les dades, per a estudiar la normalitat de les variables numériques.

En aquest cas les úniques variables que tindria sentit fer analisis de normalitat i homocedasticitat serien les que tenen sentit numèric com Age i Fare.
```{r}
summary(train_c1)
```

Per a fer el test de normalitat faré servir el test de Shapiro.

```{r}
shapiro.test(train_c1$Age)
```

```{r}
shapiro.test(train_c1$Fare)
```

El resultat del test indica que cap de les variables numériques està normalitzada, ja que els seus p-valors són inferiors a 0.05, pel que podem rebutjar la hipòtesi nul·la, sent les variables estudiades amb una distribució no-normal.

A continuació n'estudiem l'homocedasticitat per la variable Age
```{r}
lmMod<-lm(Survived~Age,data=train_x)
par(mfrow=c(2,2))
plot(lmMod)
```
Observe'm en el plot de dalt a l'esquerre que la curva vermella no es manté estable, on veiem que els residus semblen augmentar a la vegada que y o fa. Per tant aquesta variable presenta heterocedasticitat



A continuació n'estudiem l'homocedasticitat per la variable Fare
```{r}
lmMod<-lm(Survived~Fare,data=train_x)
par(mfrow=c(2,2)) 
plot(lmMod)
```

Observe'm en el plot de dalt a l'esquerre que la curva vermella no es manté estable, on veiem que els residus semblen augmentar a la vegada que y o fa. Per tant aquesta variable presenta heterocedasticitat

Degut a que cap de les variables estudiades anteriorment presenta normalitat utilitzaré el test de fligner, el qual és el més comú per a casos on no es compleixen la condició de normalitat.
```{r}
fligner.test(Survived~Age,data=train_c1)
```

```{r}
fligner.test(Survived~Fare,data=train_c1)
```
Observe'm que per les dues variables el p-value és major de 0.05, pel que podem acceptar la hipòtesi nul·la d'homoscedasticitat concloen que aquestes dues variables presenten variancies estadísticament iguals per als seus respectius grups.

### Distribució de les variables segons si sobreviu

A continuació volem veure per cada variable, els volums de passatgers segons si sobreviu o no, a fi de tenir una visió general de l'importància de cada variable.

#### Factor sobreviu segons classe
```{r}
library(ggplot2)

train_net%>%ggplot(aes(x=classe,fill=factor(Survived)))+geom_bar(stat="count",positin="fill")
```

#### Factor sobreviu segons Port d'embarcació
```{r}
library(ggplot2)

train_net%>%ggplot(aes(x=Embarked,fill=factor(Survived)))+geom_bar(stat="count",positin="fill")
```

#### Factor sobreviu segons Títol
```{r}
library(ggplot2)

train_net%>%ggplot(aes(x=Title_refactor,fill=factor(Survived)))+geom_bar(stat="count",positin="fill")
```
Per a veure correctament aquest gràfic es requereix de mostrar en una nova finestra a pantalla completa.

Podem apreciar que ser "Home sense estat civil" pot ser un clar factor de no sobreviure.




#### Factor sobreviu segons Sexe
```{r}
library(ggplot2)

train_net%>%ggplot(aes(x=Sex,fill=factor(Survived)))+geom_bar(stat="count",positin="fill")
```

A continuació apliquem el test de chi quadrat, per veure la significancia entre les variables i la variable Survived
```{r}
chisq.test(train_net$Survived,train_net$Sex)
chisq.test(train_net$Survived,train_net$Cabin)
chisq.test(train_net$Survived,train_net$Embarked)
chisq.test(train_net$Survived,train_net$Title_refactor)

chisq.test(train_net$Survived,train_net$classe)


```

Degut a que totes les variables tenen un p-value inferior a 0.05 podem assegurar que totes són significatives per al anàlisi

### Model de regressió per a poder predir supervivents

El primer model que utilitzaré és el de randomforest, on primarement dividiré el dataset en dos parts, els que tenen els supervivents informats i els que no.
```{r}
train_clean<-train_net[!is.na(train_net$Survived),]
test_clean<-train_net[is.na(train_net$Survived),]
```

Revise'm que el subdataset estigui bé
```{r}
str(train_clean)
str(test_clean)
```
```{r}
str(train_clean$Title_refactor)
unique(train_clean$Title_refactor)

```

```{r}
str(test_clean$Title_refactor)
unique(test_clean$Title_refactor)
```

Apliquem el model de randomforest sobre le subdataset on està informat si sobreviu el passatger
```{r}
library(randomForest)
set.seed(0)

rf<-randomForest(Survived~Sex + Cabin +Embarked+Title_refactor+Age+classe+SibSp+Parch+Fare,data=train_clean,ntree=401)
importance(rf)
```

```{r}
prediction<-predict(rf,newdata=test_clean)

PassengerId<-test_clean$PassengerId
output.df<-as.data.frame(PassengerId)
output.df$Survived<-prediction

write.csv(output.df,file="/Users/PcCom/Desktop/UOC/Tipologia i cicle de dades/kaggle_submission_1.csv",row.names = FALSE)
```

Realitzem una prova utilitzant regresió logística
```{r}
model<-glm(Survived~.,family=binomial(link='logit'),data=train_clean)

```

Finalment, guardem el resultat de la predicció del subdataset on no està informat si el supervivent sobreviu.

```{r}
prediction<-predict(model,newdata=test_clean)
prediction_r<-ifelse(prediction>0.5,1,0)
PassengerId<-test_clean$PassengerId
output.df<-as.data.frame(PassengerId)
output.df$Survived<-prediction_r

write.csv(output.df,file="/Users/PcCom/Desktop/UOC/Tipologia i cicle de dades/kaggle_submission_3.csv",row.names = FALSE)
```

Realitzem prova amb arbres de decisió
```{r}
library(rpart)
model_tree<-rpart(Survived~.,data=train_clean,method = 'class')

```

```{r}
prediction<-predict(model_tree,newdata=test_clean,type = 'class')

PassengerId<-test_clean$PassengerId
output.df<-as.data.frame(PassengerId)
output.df$Survived<-prediction

write.csv(output.df,file="/Users/PcCom/Desktop/UOC/Tipologia i cicle de dades/kaggle_submission_4.csv",row.names = FALSE)
```
### Resultat

Al pujar el resultat a Kaggle s'ha obtingut un resultat de 77.99% el qual és un resultat bo, millorable.

```{r  echo=FALSE, fig.align="center", fig.cap="Score Kaggle", out.width="50%"}
knitr::include_graphics("/Users/PcCom/Desktop/UOC/Tipologia i cicle de dades/Score_kaggle.png")
```
